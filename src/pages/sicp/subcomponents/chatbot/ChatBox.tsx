import { Button } from '@blueprintjs/core';
import { Buffer as NodeBuffer } from 'buffer';
import { OpenAI } from 'openai';
import * as React from 'react';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';
import Constants from 'src/commons/utils/Constants';
import { SourceTheme } from 'src/features/sicp/SourceTheme';

import SICPNotes from './SicpNotes';

Buffer.from('anything', 'base64');

if (!(window as any).Buffer) {
  (window as any).Buffer = NodeBuffer;
}

interface ChatBoxProps {
  getSection: () => string;
  getText: () => string;
}

const ChatBox: React.FC<ChatBoxProps> = ({ getSection, getText }) => {
  const chatRef = React.useRef<HTMLDivElement | null>(null);
  const key = Constants.chatGptKey;
  const [isLoading, setIsLoading] = React.useState(false);
  const [messages, setMessages] = React.useState<{ role: 'user' | 'bot'; content: string[] }[]>([
    { content: ['Ask me something about this paragraph!'], role: 'bot' }
  ]);
  const [userInput, setUserInput] = React.useState<string>('');
  // Use temp and conversation to make sure both student's query and response can be displayed
  // because of the asynchronous function
  const [temp, setTemp] = React.useState<string>('');
  const [history, setHistory] = React.useState<string>('');

  const openai = new OpenAI({
    apiKey: key,
    dangerouslyAllowBrowser: true
  });

  const handleUserInput = (event: React.ChangeEvent<HTMLInputElement>) => {
    setUserInput(event.target.value);
  };

  // To get code snippets
  const codeBlocks = (temp: string) => {
    return temp.split('```');
  };

  const text = () => {
    return '\n(2) Here is the paragraph:\n' + getText();
  };

  const section = () => {
    const sectionNumber = getSection();
    return parseInt(sectionNumber.charAt(0), 10) > 3
      ? '\n(1) There is no section summary for this section. Please answer the question based on the following paragraph\n'
      : '\n(1) Here is the summary of this section:\n' + SICPNotes[getSection()];
  };

  function getPrompt() {
    const prompt =
      'You are a competent tutor, assisting a student who is learning computer science following the textbook "Structure and Interpretation of Computer Programs,' +
      'JavaScript edition". The student request is about a paragraph of the book. The request may be a follow-up request to a request that was posed to you' +
      'previously.\n' +
      'What follows are:\n' +
      '(1) the summary of section (2) the full paragraph, (3) the history of previous questions. Please answer the student request,' +
      'not the requests of the history. If the student request is not related to the book, ask them to ask questions that are related to the book. Donot say that I provide you text\n\n' +
      section() +
      text() +
      '\n(3) Here is the history\n' +
      history;
    return prompt;
  }

  const sendMessage = () => {
    if (userInput.trim() !== '') {
      const blocks = codeBlocks(userInput);
      setMessages([...messages, { role: 'user', content: blocks }]);
      setIsLoading(true);
      getResponse(userInput);
      setHistory(his => `${his}\n${userInput}`);
      setUserInput('');
    }
  };

  const cleanMessage = () => {
    setMessages([{ content: ['Ask me something about this paragraph!'], role: 'bot' }]);
    setHistory('');
  };

  const getResponse = async (userInput: string) => {
    const prompt = getPrompt();
    try {
      const response = await openai.chat.completions.create({
        messages: [
          { role: 'system', content: prompt },
          { role: 'user', content: userInput }
        ],
        model: 'gpt-4'
      });
      setTemp(response.choices[0]?.message['content'] || '');
    } catch (error) {
      setIsLoading(false);
      setMessages([...messages, { content: [`Error: ${error.message}`], role: 'bot' }]);
    }
  };

  const renderMessageContent = (message: string | string[]) => {
    if (!Array.isArray(message)) {
      return message;
    }

    return message.map((block, index) =>
      // Assume that only javascript code snippets will appear
      block.substring(0, 10) === 'javascript' ? (
        <SyntaxHighlighter language="javascript" style={SourceTheme} key={index}>
          {block.substring(11, block.length)}
        </SyntaxHighlighter>
      ) : (
        block
      )
    );
  };

  const keyDown = (event: React.KeyboardEvent<HTMLInputElement>) => {
    if (event.key === 'Enter') {
      sendMessage();
    }
  };

  React.useEffect(() => {
    if (temp.trim() !== '') {
      // Split the response into code blocks
      setIsLoading(false);
      const blocks = codeBlocks(
        temp + '\n\nThe answer is generated by GPT-4 and may not be correct.'
      );
      setMessages([...messages, { content: blocks, role: 'bot' }]);
      setTemp('');
    }
  }, [temp, messages]);

  React.useEffect(() => {
    scrollToBottom();
  }, [messages, isLoading]);

  const scrollToBottom = () => {
    chatRef.current?.scrollTo({ top: chatRef.current?.scrollHeight });
  };

  return (
    <div className="chat-container">
      <div className="chat-message" ref={chatRef}>
        {messages.map((message, index) => (
          <div key={index} className={`message ${message.role}`} style={{ whiteSpace: 'pre-line' }}>
            {renderMessageContent(message.content)}
          </div>
        ))}
        {isLoading && <p>loading...</p>}
      </div>
      <input
        type="text"
        className="user-input"
        placeholder="Type your message here..."
        value={userInput}
        onChange={handleUserInput}
        onKeyDown={keyDown}
      />
      <div className="button-container">
        <Button className="button-send" onClick={sendMessage}>
          Send
        </Button>
        <Button className="button-clean" onClick={cleanMessage}>
          Clean
        </Button>
      </div>
    </div>
  );
};

export default ChatBox;
